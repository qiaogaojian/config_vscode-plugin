"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const vscode_1=require("vscode"),Utilities_1=require("./Utilities"),functionsConfig=require("./data/functions.json"),ValuesConfig=require("./data/values.json"),keywordsConfig=require("./data/keywords.json"),IntellisenseConfig=require("./data/intellisense.json"),Builtin_1=require("./Builtin"),Formatter_1=require("./Formatter"),functions=functionsConfig,values=ValuesConfig,keywords=keywordsConfig,intellisense=IntellisenseConfig;class Shaderlab{constructor(e,t){this.document=e,this.position=t}getDefinition(){var e=this.document.lineAt(this.position).text,t=this.getIncludeFilesContent(e,this.document.uri);for(const e of t)if(void 0!=e.content)return console.log(e.path),{uri:vscode_1.Uri.file(e.path),range:new vscode_1.Range(0,0,0,0)};return null}provideCompletions(){let e=this.document.lineAt(this.position).text,t=e.charAt(this.position.character-1),n=[];if(this.isInTagsClourse(this.document,this.position))n=this.getTagsCompletions(this.document,this.position);else{let i=Utilities_1.default.getFirstNonSpaceCharInvInText(e,this.position.character-1);":"===i||":"===t?e.trim().startsWith("#")||(n=this.getRegisterTypeSet()):n="."===t?this.getVariablesIntellisenseSet(this.document,this.position):" "===t?this.getIntellisenseSet(this.document,this.position):this.getNormalCaseSet(this.document)}return n}getTagsCompletions(e,t){let n=[],i=this.getTagsCodeStringFromPosition(e,t),r=i.replace(/[\{\"]/gi,"="),o=Utilities_1.default.removeEmptyEntry(r.split("="));return n=o.length%2==1?i.endsWith('"')?this.getTagsValueCompletionSet(o[o.length-1].trim()):this.getTagsKeyCompletionSet():i.endsWith('"')?this.getTagsKeyCompletionSet():this.getTagsValueCompletionSet(o[o.length-1].trim())}getTagsValueCompletionSet(e){let t=[];if(!intellisense||!intellisense.Tags)return t;let n=intellisense.Tags[e];if(n&&n.values)for(var i in n.values){let e=n.values[i];t.push(this.getCompletionProposal(i,"",e,vscode_1.CompletionItemKind.Property))}return t}getTagsKeyCompletionSet(){let e=[];if(!intellisense||!intellisense.Tags)return e;for(var t in intellisense.Tags){let n=intellisense.Tags[t];n&&e.push(this.getCompletionProposal(t,"",n.documentation,vscode_1.CompletionItemKind.Property))}return e}getTagsCodeStringFromPosition(e,t){let n=new vscode_1.Range(new vscode_1.Position(0,0),t),i=e.getText(n),r=i.toLowerCase().lastIndexOf("tags");if(-1!=r){let e=i.substring(r+4).trim();return e}}isInTagsClourse(e,t){let n=this.getTagsCodeStringFromPosition(e,t);return!(!n||!n.startsWith("{")||-1!==n.indexOf("}"))}getVariablesIntellisenseSet(e,t){let n=[],i=this.getAllStructsIncludeInDocuments(e),r=this.getVariableTypeName(e,t,this.getAdditonTypeString(i),i),o=this.getTypeInfoInSetByName(r,i);return o&&o.fields.forEach(e=>{n.push(this.getCompletionProposal(e.name,e.type,e.documentation,vscode_1.CompletionItemKind.Field))}),n}getAdditonTypeString(e){let t=[];return e.forEach(e=>{e&&t.push(e.label)}),t}getAllStructsIncludeInDocuments(e){let t=e.getText(),n=this.getIncludeFilesContent(t,e.uri),i=this.getStructAndItsFieldInfo(t);return i=i.concat(this.getStructAndItsFieldInfo(Builtin_1.default.StructInfo)),n.forEach(e=>{i=i.concat(this.getStructAndItsFieldInfo(e.content))}),i}getFieldTypeInStruct(e,t){if(e&&e.fields&&t)for(let n=0;n<e.fields.length;n++){let i=e.fields[n];if(i.name===t)return i.type}}getTypeInfoInSetByName(e,t){for(let n in t){let i=t[n];if(i&&i.label===e)return i}}getVariablesHierarchy(e,t){let n=[],i=e.length-1;for(let r=e.length-1+t;r>=0;r--){let t=e.charAt(r);if(")"===t){n.push(new VariableHierarchyItem(Utilities_1.default.getMethodNameIfInMethodRange(e,r-1),!0));break}let o=[" ",",","{","(","[","\t",";","+","-","*","/"];if(-1!==o.indexOf(t)){let t=e.substring(r+1,i);n.push(new VariableHierarchyItem(t,!1));break}if("."===t){let t=e.substring(r+1,i);n.push(new VariableHierarchyItem(t,!1)),i=r}}return n}getVariableTypeName(e,t,n,i){let r=new vscode_1.Range(new vscode_1.Position(0,0),t),o=e.getText(r),s=e.lineCount,a=e.lineAt(s-1),l=new vscode_1.Range(t,a.range.end),u=e.getText(l),g="",d=this.getVariablesHierarchy(o,-1).reverse();if(0===d.length)return"";let h;if(d[0].isMethod){let t=d[0].Name;if(t){let n=this.getAllMethodInfo(e);for(let e=0;e<n.length;e++){let i=n[e];if(i&&i.label.trim()===t.trim()){h=this.getMethodReturnType(i);break}}}}else{let e=d[0].Name,t=this.getVariablesInfo(o,n.join("|"));for(let n=t.length-1;n>=0;n--){let i=t[n];if(i&&i.label===e){h=i.detail;break}}if(!h){t=this.getVariablesInfo(u,n.join("|"));for(let n=0;n<t.length;n++){let i=t[n];if(i&&i.label===e){h=i.detail;break}}}!h&&values.Items[e]&&(h=values.Items[e].type)}if(h){g=h;for(let e=1;e<d.length;e++){let t=this.getTypeInfoInSetByName(g,i);g=this.getFieldTypeInStruct(t,d[e].Name)}}return g}getIntellisenseSet(e,t){let n=[],i=Utilities_1.default.getFirstNonSpaceTexInv(e,t),r=Utilities_1.default.getSecondNonSpaceTexInv(e,t);if(!i)return n;let o=e=>{for(var t in e){var i=e[t];n.push(this.getCompletionProposal(t,"",i,intellisense.ItemKind))}},s=intellisense.Items[i.toLowerCase()];return s&&s.values?o(s.values):(s=intellisense.Items[r.toLowerCase()])&&s.values&&s.operation&&2===s.operation&&o(s.values),n}getRegisterTypeSet(){let e=[];for(var t in keywords.Items.reg){let n=keywords.Items.reg[t];e.push(this.getCompletionProposal(n,"","",keywords.ItemKind))}return e}getAllMethodInfo(e){let t=[];for(var n in functions.Items){var i=functions.Items[n];t.push(this.getCompletionProposal(n,i.detail,i.Synopsis,functions.ItemKind))}let r=e.getText();return t=t.concat(this.getMethodInfo(r)),this.getIncludeFilesContent(r,e.uri).forEach(e=>{t=t.concat(this.getMethodInfo(e.content))}),t}getNormalCaseSet(e){let t=[];for(var n in functions.Items){i=functions.Items[n];t.push(this.getCompletionProposal(n,i.detail,i.documentation,functions.ItemKind))}for(var n in values.Items){i=values.Items[n];t.push(this.getCompletionProposal(n,i.detail,i.documentation,values.ItemKind))}for(var n in keywords.Items){var i=keywords.Items[n];for(var r in i){let e=i[r];if(!e)continue;let n=this.getDocumentationInIntellisenseConfig(e.toLowerCase(),intellisense);t.push(this.getCompletionProposal(e,"",n,keywords.ItemKind))}}let o=e.getText();t=t.concat(this.getMethodInfo(o));let s=this.getIncludeFilesContent(o,e.uri);s.forEach(e=>{t=t.concat(this.getMethodInfo(e.content))}),t=t.concat(this.getMacrosDefinations(o)),s.forEach(e=>{t=t.concat(this.getMacrosDefinations(e.content))}),t=t.concat(this.getPropertiesInfo(o));var a=this.getStructuresInfo(o);t=t.concat(a),s.forEach(e=>{a=a.concat(this.getStructuresInfo(e.content)),t=t.concat(a)});let l=[];return a.forEach(e=>{e&&l.push(e.label)}),t=t.concat(this.getVariablesInfo(o,l.join("|")))}getMacrosDefinations(e){return this.getCompletionItemFromMatchResult(e,this.getMacrosDefinitationFromCode,e=>{let t=e.indexOf("(");return-1!==t?this.getCompletionProposal(e.substring(8,t),"","",vscode_1.CompletionItemKind.Method):this.getCompletionProposal(e.substring(8),"","",vscode_1.CompletionItemKind.Property)})}getVariablesInfo(e,t){let n=[],i=this.getVariablesFromCode(e,t);for(var r in i){let e=i[r];if(e){let t=e.substring(0,e.length-1).split(" ",2);if(2==t.length){let e=t[0].trim(),i=t[1].trim();n.push(this.getCompletionProposal(i,e,"",vscode_1.CompletionItemKind.Variable))}}}return n}getPropertiesInfo(e){return this.getCompletionItemFromMatchResult(e,this.getPropertiesDefinationFromCode,e=>{let t=e.replace(/\(/gi,",").replace(/\)/gi,",").split(",");if(t.length>=4)return this.getCompletionProposal(t[0].trim(),t[2].trim(),"",vscode_1.CompletionItemKind.Property)})}getStructuresInfo(e){return this.getCompletionItemFromMatchResult(e,this.getStructDefinationFromCode,e=>{let t=e.substring(6,e.length-7).split("{");if(t.length>=2)return this.getCompletionProposal(t[0].trim(),"struct","",vscode_1.CompletionItemKind.Struct)})}getStructAndItsFieldInfo(e){let t=[],n=this.getStructDefinationFromCode(e),i=new Formatter_1.default("\t");for(var r in n){let e=i.removeComments(n[r]);if(e){let n=e.substring("struct".length).split("{",2);if(2==n.length){let e=new TypeInfomation,i=n[0].trim();e.label=i;let r=n[1].trim().split(/[;\r\n]/);for(var o in r){let t=r[o],n=this.getTypeFiledInfomation(t);if(n){var s=this.getTypeFiledInfomation(t);if(-1!==s.name.indexOf(",")){let t=s.name.split(",");for(let n=0;n<t.length;n++){let i=new TypeFiledInformation;i.name=t[n].trim(),i.documentation=s.documentation,i.type=s.type,e.fields.push(i)}}else e.fields.push(s)}}t.push(e)}}}return t}getTypeFiledInfomation(e){let t=e.trim(),n=t.indexOf("//");if(-1!==n&&(t=t.substring(0,n+1)),-1!==(n=t.indexOf(":"))&&(t=t.split(":",2)[0]),-1!==t.indexOf(",")){let n=Utilities_1.default.removeEmptyEntry(t.split(",")),i=new TypeFiledInformation,r=n[0].split(" ");return r.length>=2&&(i.type=r[r.length-2].trim()),n[0]=r[r.length-1].trim(),i.name=n.join(","),i.documentation=e.trim(),i}{let n=Utilities_1.default.removeEmptyEntry(t.split(" "));if(n.length>=2){let t=new TypeFiledInformation;return t.name=n[n.length-1].trim(),-1!=t.name.indexOf("[")&&(t.name=t.name.split("[")[0]),t.type=n[n.length-2].trim(),t.documentation=e.trim(),t}}}getMethodReturnType(e){if(e.kind===vscode_1.CompletionItemKind.Method&&"string"==typeof e.documentation){let t=Utilities_1.default.removeEmptyEntry(e.documentation.split(" "));if(t.length>0)return t[0]}}getMethodInfo(e){return this.getCompletionItemFromMatchResult(e,this.getMethodCodeLineFromCode,e=>{let t=this.getMethodNameFromSignatureCode(e);if(t)return this.getCompletionProposal(t,"",e.substring(0,e.length-1).trim(),vscode_1.CompletionItemKind.Method)})}getCompletionItemFromMatchResult(e,t,n){let i=[],r=t(e);for(var o in r){let e=r[o];if(e){let t=n(e);t&&i.push(n(e))}}return i}getCompletionProposal(e,t,n,i){let r=new vscode_1.CompletionItem(e,i);return r.detail=t,r.documentation=n,r}provideHover(){let e,t=this.document.getWordRangeAtPosition(this.position),n=this.document.getText(t);if(e=values.Items[n])return new vscode_1.Hover(e.documentation,t);var i=this.document.lineAt(this.position.line).text;if(e=functions.Items[n]){let n=!1;for(let e=t.end.character;e<i.length;e++){let t=i.charAt(e);if(" "!==t){if("("===t){n=!0;break}break}}if(n)return new vscode_1.Hover(e.documentation,t)}let r=this.getDocumentationInIntellisenseConfig(n.toLowerCase(),intellisense);return r?new vscode_1.Hover(r,t):n!=this.document.getText()&&/[\w_\d]+/.test(n)?new vscode_1.Hover(n,t):null}provideSignatureHelp(){let e=this.getFunctionName(this.document,this.position);if(!e)return;let t=new vscode_1.SignatureHelp,n=this.document.getText(),i=this.getSignatureInCodeByName(n,e);if(i)t.signatures.push(i);else{let o=this.getIncludeFilesContent(n,this.document.uri);for(var r in o){let n=o[r];if(n&&(i=this.getSignatureInCodeByName(n.content,e))){t.signatures.push(i);break}}}if(!i){let n=this.getSignatureDataByFuncNameInConfig(e);n&&n.Synopsis.forEach(e=>{t.signatures.push(this.getSignatureInformationFromCode(e,n.documentation))})}return t.activeSignature=0,t.activeParameter=this.calcActiveParameter(this.document,this.position),t}getSignatureInCodeByName(e,t){let n=this.getMethodInfoInCode(e);for(var i in n){let e=n[i];if(e&&e.name===t)return this.getSignatureInformationFromCode(e.signature,e.signature)}let r=this.getMacrosDefinitationFromCode(e);for(var i in r){let e=r[i],n=e.indexOf("(");if(-1!==n){let i=e.substring(8,n);if(i===t)return this.getSignatureInformationFromCode(e.substring(8),e)}}}getMethodInfoInCode(e){let t=[],n=this.getMethodCodeLineFromCode(e);for(var i in n){let e=n[i];if(e){let n=this.getMethodNameFromSignatureCode(e),i=e.substring(0,e.length-1).trim();t.push({name:n,signature:i})}}return t}getSignatureInformationFromCode(e,t){let n=new vscode_1.SignatureInformation(e);n.documentation=t;let i=this.getParameterInfosFromSignatureCode(e);return n.parameters=i,n}getSignatureDataByFuncNameInConfig(e){return functions.Items[e]}getFunctionName(e,t){let n,i=e.lineAt(t.line),r=1;for(n=t.character-1;n>0&&r>0;n--){let e=i.text.charAt(n);")"===e&&r++,"("===e&&r--}if(r>0||n<=0)return"";let o=new vscode_1.Position(t.line,n);return e.getText(e.getWordRangeAtPosition(o))}calcActiveParameter(e,t){let n=e.lineAt(t.line),i=0,r=0;for(let e=t.character-1;e>0;e--){let t=n.text.charAt(e);","===t&&0===r&&i++,"("===t&&r++,")"===t&&r--}return i}provideSymbols(){return this.getDocumentSymbols(this.document)}static getMatchResult(e,t,n){return t.match(new RegExp(e.source,n))}getMethodSymbols(e){let t=Shaderlab.getSymbols(Shaderlab.getMethodRegPattern(),e,vscode_1.SymbolKind.Method,"gm");return t.forEach(e=>e.name=this.getMethodNameFromSignatureCode(e.name)),t}getVariablesSymbols(e,t){let n=Shaderlab.getSymbols(this.getVariablesRegPattern(t,!0),e,vscode_1.SymbolKind.Variable,"g");return n.forEach(e=>{let t=Utilities_1.default.removeEmptyEntry(e.name.trim().split(/[ \t\r\n\);,:]/));t.length>1?e.name=t[1]:e.name=t[0]}),n}getStructDefinationSymbols(e){let t=Shaderlab.getSymbols(Shaderlab.getStructDefinationRegPattern(),e,vscode_1.SymbolKind.Class,"gm");return t.forEach(e=>e.name=e.name.trim().split(/[ \t\r\n\{]/)[1]),t}getPropertiesDefinationSymbols(e){let t=Shaderlab.getSymbols(Shaderlab.getPropertiesDefinationRegPattern(),e,vscode_1.SymbolKind.Property,"g");return t.forEach(e=>e.name=e.name.trim().split(/[ \t]/)[0]),t}getMacrosDefinationSymbols(e){let t=Shaderlab.getSymbols(Shaderlab.GetMacrosRegPattern(),e,vscode_1.SymbolKind.Property,"g");return t.forEach(e=>{let t=e.name.indexOf("(");-1!==t?(e.name=e.name.substring(8,t),e.kind=vscode_1.SymbolKind.Method):e.name=e.name.substring(8)}),t}getDocumentSymbols(e){let t=this.getMethodSymbols(e);t=(t=t.concat(this.getStructDefinationSymbols(e))).concat(this.getPropertiesDefinationSymbols(e));let n=this.getAdditonTypeString(this.getAllStructsIncludeInDocuments(e));return t=t.concat(this.getVariablesSymbols(e,n.join("|"))),t=t.concat(this.getMacrosDefinationSymbols(e))}getDocumentationInIntellisenseConfig(e,t){if(e){var n=t.Items[e];if(n)return n.documentation}return""}getParameterInfosFromSignatureCode(e){let t=[],n=e.replace("(",",").replace(")","").split(",");if(n.length>1)for(var i=1;i<n.length;i++){let r=n[i],o=new vscode_1.ParameterInformation(e);o.label=r,t.push(o)}return t}getMethodNameFromSignatureCode(e){let t=e.replace("("," ").split(" "),n=0;for(let e=0;e<t.length;e++)if(t[e]&&n<1)n++;else if(1===n)return t[e]}getIncludeFilesContent(e,t){let n=[];return this.getIncludeFiles(e).forEach(e=>{let i=Utilities_1.default.getPath(t,e);if(!i)return;let r=Utilities_1.default.readFile(i.fsPath);r&&n.push(new IncludeFile(i.path,r))}),n}getIncludeFiles(e){let t=[],n={},i=this.getIncludeDefinationFromCode(e);for(var r in i){let e=i[r];if(e){let i=e.split('"');i.length>2&&(n[i[1]]||(t.push(i[1]),n[i[1]]=1))}}return t}getMethodCodeLineFromCode(e){return Shaderlab.getMatchResult(Shaderlab.getMethodRegPattern(),e,"gm")}getVariablesFromCode(e,t){let n=this.getVariablesRegPattern(t);return Shaderlab.getMatchResult(n,e,"g")}getStructDefinationFromCode(e){return Shaderlab.getMatchResult(Shaderlab.getStructDefinationRegPattern(),e,"gm")}getPropertiesDefinationFromCode(e){return Shaderlab.getMatchResult(Shaderlab.getPropertiesDefinationRegPattern(),e,"g")}getIncludeDefinationFromCode(e){return Shaderlab.getMatchResult(Shaderlab.getIncludeDefinationRegPattern(),e,"g")}getMacrosDefinitationFromCode(e){return Shaderlab.getMatchResult(Shaderlab.GetMacrosRegPattern(),e,"g")}static getMethodRegPattern(){return/[\d\w_]+?\s+?(?!if|for)[\d\w_]+?\s*?\([\s\d\w,:_]*?\)\s*?(:[\s\d\w_]+?){0,1}\s*?\{/}static GetMacrosRegPattern(){return/#define[ \t]+([\d\w_]+)(\([\d\w_, ]+\))?/}getVariablesRegPattern(e,t=!1){let n,i=`((InputPatch|OutputPatch|RWByteAddressBuffer|RWBuffer|ConsumeStructuredBuffer|ByteAddressBuffer|Buffer|AppendStructuredBuffer|Texture2DMS|Texture2DMSArray|TextureCube|TextureCubeArray|Texture1DArray|RWTexture1DArray|RWTexture2DArray|Texture2DArray|RWTexture2D|Texture2D|StructuctedBuffer|RWStructuredBuffer|RWTexture3D|Texture3D|RWTexture1D|Texture1D)(<[\\w\\d]+?>)?)|SurfaceOutput|appdata_base|appdata_tan|appdata_full|appdata_img|sampler|sampler2D|sampler3D|samplerCUBE|string|triangle|triangleadj|vector|((float|int|uint|bool|half|fixed|double)(\\d*?|\\d*?x\\d*?))`;return n=e?t?`(${i}|${e})\\s+?[\\w\\d_]+?\\s*?[;=]`:`(${i}|${e})\\s+?[\\w\\d_]+?\\s*?[:;)=,]`:t?`(${i})\\s+?[\\w\\d_]+?\\s*?[;=]`:`(${i})\\s+?[\\w\\d_]+?\\s*?[;:)=,]`,new RegExp(n)}static getStructDefinationRegPattern(){return/\bstruct\b\s*?[\S]*?\s*?\{[\s\S]*?\}[\s]*?;?/}static getPropertiesDefinationRegPattern(){return/[_\d\w]+?\s*?\("[\s\S]*?",[\s\S]*?\)\s*?=/}static getIncludeDefinationRegPattern(){return/#include\s*?\"[\s\S]+?\"/}static getSymbols(e,t,n,i){let r=new RegExp(e.source,i),o=null,s=[],a=t.getText();for(;o=r.exec(a);){let e=t.positionAt(o.index).line,i=t.lineAt(e).range;o[0];s.push(new vscode_1.SymbolInformation(o[0].trim(),n,"",new vscode_1.Location(t.uri,i)))}return s}}class MethodInfo{constructor(e,t,n){this.name=e,this.filePath=t,this.code=n}}class TypeInfomation{constructor(){this.label="",this.fields=[]}}class VariableHierarchyItem{constructor(e,t){this.Name=e,this.isMethod=t}}class IncludeFile{constructor(e,t){this.path=e,this.content=t}}class TypeFiledInformation{constructor(){this.type="",this.name="",this.documentation=""}}exports.default=Shaderlab;