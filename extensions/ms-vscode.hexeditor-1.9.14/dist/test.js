"use strict";var qr=Object.create;var X=Object.defineProperty;var Mr=Object.getOwnPropertyDescriptor;var Br=Object.getOwnPropertyNames;var Hr=Object.getPrototypeOf,zr=Object.prototype.hasOwnProperty;var v=(r,e)=>()=>(r&&(e=r(r=0)),e);var f=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),jr=(r,e)=>{for(var t in e)X(r,t,{get:e[t],enumerable:!0})},Ot=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Br(e))!zr.call(r,i)&&i!==t&&X(r,i,{get:()=>e[i],enumerable:!(s=Mr(e,i))||s.enumerable});return r};var P=(r,e,t)=>(t=r!=null?qr(Hr(r)):{},Ot(e||!r||!r.__esModule?X(t,"default",{value:r,enumerable:!0}):t,r)),Lr=r=>Ot(X({},"__esModule",{value:!0}),r);var Te=f(K=>{"use strict";Object.defineProperty(K,"__esModule",{value:!0});K.ConstantBackoff=void 0;var ke=class{constructor(e){this.interval=e}next(){return Wr(this.interval)}};K.ConstantBackoff=ke;var Wr=r=>({duration:r,next(){return this}})});var Pt=f(ee=>{"use strict";Object.defineProperty(ee,"__esModule",{value:!0});ee.DelegateBackoff=void 0;var qe=class{constructor(e){this.fn=e}next(e){return Me(this.fn).next(e)}};ee.DelegateBackoff=qe;var Me=(r,e,t=0)=>({duration:t,next(s){let i=r(s,e);return typeof i=="number"?Me(r,e,i):Me(r,i.state,i.delay)}})});var Be=f(E=>{"use strict";Object.defineProperty(E,"__esModule",{value:!0});E.decorrelatedJitterGenerator=E.halfJitterGenerator=E.fullJitterGenerator=E.noJitterGenerator=void 0;var Gr=(r=0,e)=>[Math.min(e.maxDelay,e.initialDelay*2**r),r+1];E.noJitterGenerator=Gr;var Nr=(r,e)=>{let[t,s]=(0,E.noJitterGenerator)(r,e);return[Math.floor(Math.random()*t),s]};E.fullJitterGenerator=Nr;var Qr=(r,e)=>{let[t,s]=(0,E.noJitterGenerator)(r,e);return[Math.floor((t+Math.random()*t)/2),s]};E.halfJitterGenerator=Qr;var $r=4,Jr=1/1.4,Vr=(r,e)=>{let[t,s]=r||[0,0],i=t+Math.random(),o=Math.pow(e.exponent,i)*Math.tanh(Math.sqrt($r*i)),n=Math.max(0,o-s);return[Math.min(n*Jr*e.initialDelay,e.maxDelay),[t+1,o]]};E.decorrelatedJitterGenerator=Vr});var qt=f(te=>{"use strict";Object.defineProperty(te,"__esModule",{value:!0});te.ExponentialBackoff=void 0;var Yr=Be(),kt={generator:Yr.decorrelatedJitterGenerator,maxDelay:3e4,exponent:2,initialDelay:128},He=class{constructor(e){this.options=e?{...kt,...e}:kt}next(){return Tt(this.options).next(void 0)}};te.ExponentialBackoff=He;var Tt=(r,e,t=0,s=-1)=>({duration:t,next(){let[i,o]=r.generator(e,r);return Tt(r,o,i,s+1)}})});var Bt=f(re=>{"use strict";Object.defineProperty(re,"__esModule",{value:!0});re.IterableBackoff=void 0;var ze=class{constructor(e){this.durations=e}next(){return Mt(this.durations,0)}};re.IterableBackoff=ze;var Mt=(r,e)=>({duration:r[e],next(){return e===r.length-1?this:Mt(r,e+1)}})});var je=f(S=>{"use strict";var Zr=S&&S.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,i)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),G=S&&S.__exportStar||function(r,e){for(var t in r)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&Zr(e,r,t)};Object.defineProperty(S,"__esModule",{value:!0});G(Te(),S);G(Pt(),S);G(qt(),S);G(Be(),S);G(Bt(),S)});var ie=f(se=>{"use strict";Object.defineProperty(se,"__esModule",{value:!0});se.TaskCancelledError=void 0;var Le=class extends Error{constructor(e="Operation cancelled"){super(e),this.message=e,this.isTaskCancelledError=!0}};se.TaskCancelledError=Le});var U=f(x=>{"use strict";Object.defineProperty(x,"__esModule",{value:!0});x.MemorizingEventEmitter=x.EventEmitter=x.onAbort=x.Event=x.noopDisposable=void 0;var Ht=ie();x.noopDisposable={dispose:()=>{}};var Xr;(function(r){r.once=(e,t)=>{let s=!1,i;return i=e(o=>{t(o),i?i.dispose():s=!0}),s?(i.dispose(),x.noopDisposable):i},r.toPromise=(e,t)=>t?t.aborted?Promise.reject(new Ht.TaskCancelledError):new Promise((s,i)=>{let o=(0,x.onAbort)(t)(()=>{n.dispose(),i(new Ht.TaskCancelledError)}),n=r.once(e,a=>{o.dispose(),s(a)})}):new Promise(s=>r.once(e,s))})(Xr=x.Event||(x.Event={}));var Kr=r=>{let e=new Ge;if(r.aborted)return e.emit(),e.addListener;let t=()=>{e.emit(),r.removeEventListener("abort",t)};return r.addEventListener("abort",t),e.addListener};x.onAbort=Kr;var N=class{constructor(){this.addListener=e=>this.addListenerInner(e)}get size(){return this.listeners?typeof this.listeners=="function"?1:this.listeners.length:0}emit(e){if(this.listeners)if(typeof this.listeners=="function")this.listeners(e);else for(let t of this.listeners)t(e)}addListenerInner(e){return this.listeners?typeof this.listeners=="function"?this.listeners=[this.listeners,e]:this.listeners.push(e):this.listeners=e,{dispose:()=>this.removeListener(e)}}removeListener(e){if(!this.listeners)return;if(typeof this.listeners=="function"){this.listeners===e&&(this.listeners=void 0);return}let t=this.listeners.indexOf(e);t!==-1&&(this.listeners.length===2?this.listeners=t===0?this.listeners[1]:this.listeners[0]:this.listeners=this.listeners.slice(0,t).concat(this.listeners.slice(t+1)))}};x.EventEmitter=N;var We=class extends N{constructor(){super(...arguments),this.addListener=e=>{let t=this.addListenerInner(e);return this.lastValue&&e(this.lastValue.value),t}}get hasEmitted(){return!!this.lastValue}emit(e){this.lastValue={value:e},super.emit(e)}};x.MemorizingEventEmitter=We;var Ge=class extends N{constructor(){super(...arguments),this.addListener=e=>this.lastValue?(e(this.lastValue.value),x.noopDisposable):this.addListenerInner(e)}emit(e){this.lastValue={value:e},super.emit(e),this.listeners=void 0}}});var k=f(_=>{"use strict";Object.defineProperty(_,"__esModule",{value:!0});_.deriveAbortController=_.abortedSignal=_.neverAbortedSignal=void 0;var es=U();_.neverAbortedSignal=new AbortController().signal;var zt=new AbortController;zt.abort();_.abortedSignal=zt.signal;var ts=r=>{let e=new AbortController;if(!r)return e;if(r.aborted&&e.abort(),r!==_.neverAbortedSignal){let t=new WeakRef(e);(0,es.onAbort)(r)(()=>t.deref()?.abort())}return e};_.deriveAbortController=ts});var H=f(B=>{"use strict";Object.defineProperty(B,"__esModule",{value:!0});B.ExecuteWrapper=B.returnOrThrow=void 0;var jt=U(),rs=r=>{if("error"in r)throw r.error;return"success"in r?r.success:r.value};B.returnOrThrow=rs;var ss=()=>{if(typeof performance<"u"){let r=performance.now();return()=>performance.now()-r}else{let r=process.hrtime.bigint();return()=>Number(process.hrtime.bigint()-r)/1e6}},Ne=class r{constructor(e=()=>!1,t=()=>!1){this.errorFilter=e,this.resultFilter=t,this.successEmitter=new jt.EventEmitter,this.failureEmitter=new jt.EventEmitter,this.onSuccess=this.successEmitter.addListener,this.onFailure=this.failureEmitter.addListener}clone(){return new r(this.errorFilter,this.resultFilter)}async invoke(e,...t){let s=this.successEmitter.size||this.failureEmitter.size?ss():null;try{let i=await e(...t);return this.resultFilter(i)?(s&&this.failureEmitter.emit({duration:s(),handled:!0,reason:{value:i}}),{value:i}):(s&&this.successEmitter.emit({duration:s()}),{success:i})}catch(i){let o=i,n=this.errorFilter(o);if(s&&this.failureEmitter.emit({duration:s(),handled:n,reason:{error:o}}),!n)throw o;return{error:o}}}};B.ExecuteWrapper=Ne});var $e=f(ne=>{"use strict";Object.defineProperty(ne,"__esModule",{value:!0});ne.BrokenCircuitError=void 0;var Qe=class extends Error{constructor(e="Execution prevented because the circuit breaker is open"){super(e),this.isBrokenCircuitError=!0}};ne.BrokenCircuitError=Qe});var Ve=f(oe=>{"use strict";Object.defineProperty(oe,"__esModule",{value:!0});oe.BulkheadRejectedError=void 0;var Je=class extends Error{constructor(e,t){super(`Bulkhead capacity exceeded (0/${e} execution slots, 0/${t} available)`),this.isBulkheadRejectedError=!0}};oe.BulkheadRejectedError=Je});var Ze=f(ae=>{"use strict";Object.defineProperty(ae,"__esModule",{value:!0});ae.IsolatedCircuitError=void 0;var is=$e(),Ye=class extends is.BrokenCircuitError{constructor(){super("Execution prevented because the circuit breaker is open"),this.isIsolatedCircuitError=!0}};ae.IsolatedCircuitError=Ye});var ue=f(g=>{"use strict";var ns=g&&g.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,i)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),ce=g&&g.__exportStar||function(r,e){for(var t in r)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&ns(e,r,t)};Object.defineProperty(g,"__esModule",{value:!0});g.isTaskCancelledError=g.isIsolatedCircuitError=g.isBulkheadRejectedError=g.isBrokenCircuitError=void 0;ce($e(),g);ce(Ve(),g);ce(Ze(),g);ce(ie(),g);var os=r=>!!r&&r instanceof Error&&"isBrokenCircuitError"in r;g.isBrokenCircuitError=os;var as=r=>!!r&&r instanceof Error&&"isBulkheadRejectedError"in r;g.isBulkheadRejectedError=as;var cs=r=>!!r&&r instanceof Error&&"isBulkheadRejectedError"in r;g.isIsolatedCircuitError=cs;var us=r=>!!r&&r instanceof Error&&"isBulkheadRejectedError"in r;g.isTaskCancelledError=us});var de=f(T=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0});T.CircuitBreakerPolicy=T.CircuitState=void 0;var ls=k(),le=U(),Lt=H(),Wt=ue(),ds=Ze(),y;(function(r){r[r.Closed=0]="Closed",r[r.Open=1]="Open",r[r.HalfOpen=2]="HalfOpen",r[r.Isolated=3]="Isolated"})(y=T.CircuitState||(T.CircuitState={}));var Xe=class{constructor(e,t){this.options=e,this.executor=t,this.breakEmitter=new le.EventEmitter,this.resetEmitter=new le.EventEmitter,this.halfOpenEmitter=new le.EventEmitter,this.stateChangeEmitter=new le.EventEmitter,this.innerState={value:y.Closed},this.onBreak=this.breakEmitter.addListener,this.onReset=this.resetEmitter.addListener,this.onHalfOpen=this.halfOpenEmitter.addListener,this.onStateChange=this.stateChangeEmitter.addListener,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure}get state(){return this.innerState.value}get lastFailure(){return this.innerLastFailure}isolate(){this.innerState.value!==y.Isolated&&(this.innerState={value:y.Isolated,counters:0},this.breakEmitter.emit({isolated:!0}),this.stateChangeEmitter.emit(y.Isolated)),this.innerState.counters++;let e=!1;return{dispose:()=>{e||(e=!0,this.innerState.value===y.Isolated&&!--this.innerState.counters&&(this.innerState={value:y.Closed},this.resetEmitter.emit(),this.stateChangeEmitter.emit(y.Closed)))}}}async execute(e,t=ls.neverAbortedSignal){let s=this.innerState;switch(s.value){case y.Closed:let i=await this.executor.invoke(e,{signal:t});return"success"in i?this.options.breaker.success(s.value):(this.innerLastFailure=i,this.options.breaker.failure(s.value)&&this.open(i)),(0,Lt.returnOrThrow)(i);case y.HalfOpen:if(await s.test.catch(()=>{}),this.state===y.Closed&&t.aborted)throw new Wt.TaskCancelledError;return this.execute(e);case y.Open:if(Date.now()-s.openedAt<this.options.halfOpenAfter)throw new Wt.BrokenCircuitError;let o=this.halfOpen(e,t);return this.innerState={value:y.HalfOpen,test:o},this.stateChangeEmitter.emit(y.HalfOpen),o;case y.Isolated:throw new ds.IsolatedCircuitError;default:throw new Error(`Unexpected circuit state ${s}`)}}async halfOpen(e,t){this.halfOpenEmitter.emit();try{let s=await this.executor.invoke(e,{signal:t});return"success"in s?(this.options.breaker.success(y.HalfOpen),this.close()):(this.innerLastFailure=s,this.options.breaker.failure(y.HalfOpen),this.open(s)),(0,Lt.returnOrThrow)(s)}catch(s){throw this.close(),s}}open(e){this.state===y.Isolated||this.state===y.Open||(this.innerState={value:y.Open,openedAt:Date.now()},this.breakEmitter.emit(e),this.stateChangeEmitter.emit(y.Open))}close(){this.state===y.HalfOpen&&(this.innerState={value:y.Closed},this.resetEmitter.emit(),this.stateChangeEmitter.emit(y.Closed))}};T.CircuitBreakerPolicy=Xe});var Nt=f(fe=>{"use strict";Object.defineProperty(fe,"__esModule",{value:!0});fe.SamplingBreaker=void 0;var Gt=de(),Ke=class{constructor({threshold:e,duration:t,minimumRps:s}){if(this.windows=[],this.currentWindow=0,this.currentFailures=0,this.currentSuccesses=0,e<=0||e>=1)throw new RangeError(`SamplingBreaker threshold should be between (0, 1), got ${e}`);this.threshold=e;let i=Math.max(5,Math.ceil(t/1e3));for(let o=0;o<i;o++)this.windows.push({startedAt:0,failures:0,successes:0});this.windowSize=Math.round(t/i),this.duration=this.windowSize*i,s?this.minimumRpms=s/1e3:this.minimumRpms=5/(e*1e3)}success(e){e===Gt.CircuitState.HalfOpen&&this.resetWindows(),this.push(!0)}failure(e){if(this.push(!1),e!==Gt.CircuitState.Closed)return!0;let t=this.currentSuccesses+this.currentFailures;return t<this.duration*this.minimumRpms?!1:this.currentFailures>this.threshold*t}resetWindows(){this.currentFailures=0,this.currentSuccesses=0;for(let e of this.windows)e.failures=0,e.successes=0,e.startedAt=0}rotateWindow(e){let t=(this.currentWindow+1)%this.windows.length;this.currentFailures-=this.windows[t].failures,this.currentSuccesses-=this.windows[t].successes;let s=this.windows[t]={failures:0,successes:0,startedAt:e};return this.currentWindow=t,s}push(e){let t=Date.now(),s=this.windows[this.currentWindow];t-s.startedAt>=this.windowSize&&(s=this.rotateWindow(t)),e?(s.successes++,this.currentSuccesses++):(s.failures++,this.currentFailures++)}};fe.SamplingBreaker=Ke});var Qt=f(pe=>{"use strict";Object.defineProperty(pe,"__esModule",{value:!0});pe.ConsecutiveBreaker=void 0;var et=class{constructor(e){this.threshold=e,this.count=0}success(){this.count=0}failure(){return++this.count>=this.threshold}};pe.ConsecutiveBreaker=et});var Jt=f(I=>{"use strict";var fs=I&&I.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,i)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),$t=I&&I.__exportStar||function(r,e){for(var t in r)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&fs(e,r,t)};Object.defineProperty(I,"__esModule",{value:!0});$t(Nt(),I);$t(Qt(),I)});var Vt=f(he=>{"use strict";Object.defineProperty(he,"__esModule",{value:!0});he.defer=void 0;var ps=()=>{let r,e,t=new Promise((s,i)=>{r=s,e=i});return{resolve:r,reject:e,promise:t}};he.defer=ps});var rt=f(me=>{"use strict";Object.defineProperty(me,"__esModule",{value:!0});me.BulkheadPolicy=void 0;var hs=k(),ms=Vt(),ys=U(),bs=H(),vs=Ve(),ws=ue(),tt=class{constructor(e,t){this.capacity=e,this.queueCapacity=t,this.active=0,this.queue=[],this.onRejectEmitter=new ys.EventEmitter,this.executor=new bs.ExecuteWrapper,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure,this.onReject=this.onRejectEmitter.addListener}get executionSlots(){return this.capacity-this.active}get queueSlots(){return this.queueCapacity-this.queue.length}async execute(e,t=hs.neverAbortedSignal){if(t.aborted)throw new ws.TaskCancelledError;if(this.active<this.capacity){this.active++;try{return await e({signal:t})}finally{this.active--,this.dequeue()}}if(this.queue.length<this.queueCapacity){let{resolve:s,reject:i,promise:o}=(0,ms.defer)();return this.queue.push({signal:t,fn:e,resolve:s,reject:i}),o}throw this.onRejectEmitter.emit(),new vs.BulkheadRejectedError(this.capacity,this.queueCapacity)}dequeue(){let e=this.queue.shift();e&&Promise.resolve().then(()=>this.execute(e.fn,e.signal)).then(e.resolve).catch(e.reject)}};me.BulkheadPolicy=tt});var nt=f(ye=>{"use strict";Object.defineProperty(ye,"__esModule",{value:!0});ye.FallbackPolicy=void 0;var gs=k(),st=class{constructor(e,t){this.executor=e,this.value=t,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure}async execute(e,t=gs.neverAbortedSignal){let s=await this.executor.invoke(e,{signal:t});return"success"in s?s.success:this.value()}};ye.FallbackPolicy=st});var at=f(be=>{"use strict";Object.defineProperty(be,"__esModule",{value:!0});be.NoopPolicy=void 0;var xs=k(),Yt=H(),ot=class{constructor(){this.executor=new Yt.ExecuteWrapper,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure}async execute(e,t=xs.neverAbortedSignal){return(0,Yt.returnOrThrow)(await this.executor.invoke(e,{signal:t}))}};be.NoopPolicy=ot});var ut=f(ve=>{"use strict";Object.defineProperty(ve,"__esModule",{value:!0});ve.RetryPolicy=void 0;var Es=Te(),Ss=k(),Zt=U(),Rs=(r,e)=>new Promise(t=>{let s=setTimeout(t,r);e&&s.unref()}),ct=class r{constructor(e,t){this.options=e,this.executor=t,this.onGiveUpEmitter=new Zt.EventEmitter,this.onRetryEmitter=new Zt.EventEmitter,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure,this.onRetry=this.onRetryEmitter.addListener,this.onGiveUp=this.onGiveUpEmitter.addListener}dangerouslyUnref(){return new r({...this.options,unref:!0},this.executor.clone())}async execute(e,t=Ss.neverAbortedSignal){let s=this.options.backoff||new Es.ConstantBackoff(0),i;for(let o=0;;o++){let n=await this.executor.invoke(e,{attempt:o,signal:t});if("success"in n)return n.success;if(!t.aborted&&o<this.options.maxAttempts){let a={attempt:o+1,signal:t,result:n};i=i?i.next(a):s.next(a);let c=i.duration,l=Rs(c,!!this.options.unref);this.onRetryEmitter.emit({...n,delay:c}),await l;continue}if(this.onGiveUpEmitter.emit(n),"error"in n)throw n.error;return n.value}}};ve.RetryPolicy=ct});var pt=f(q=>{"use strict";Object.defineProperty(q,"__esModule",{value:!0});q.TimeoutPolicy=q.TimeoutStrategy=void 0;var As=k(),lt=U(),dt=H(),_s=ie(),Xt;(function(r){r.Cooperative="optimistic",r.Aggressive="aggressive"})(Xt=q.TimeoutStrategy||(q.TimeoutStrategy={}));var ft=class r{constructor(e,t,s=new dt.ExecuteWrapper,i=!1){this.duration=e,this.options=t,this.executor=s,this.unref=i,this.timeoutEmitter=new lt.EventEmitter,this.onTimeout=this.timeoutEmitter.addListener,this.onFailure=this.executor.onFailure,this.onSuccess=this.executor.onSuccess}dangerouslyUnref(){return new r(this.duration,this.options,this.executor,!0)}async execute(e,t){let s=(0,As.deriveAbortController)(t),i=setTimeout(()=>s.abort(),this.duration);this.unref&&i.unref();let o={signal:s.signal},n=(0,lt.onAbort)(s.signal),a=n(()=>this.timeoutEmitter.emit());try{return this.options.strategy===Xt.Cooperative?(0,dt.returnOrThrow)(await this.executor.invoke(e,o,s.signal)):await this.executor.invoke(async()=>Promise.race([Promise.resolve(e(o,s.signal)),lt.Event.toPromise(n).then(()=>{throw new _s.TaskCancelledError(`Operation timed out after ${this.duration}ms`)})])).then(dt.returnOrThrow)}finally{a.dispose(),this.options.abortOnReturn!==!1&&s.abort(),clearTimeout(i)}}};q.TimeoutPolicy=ft});var Kt=f(d=>{"use strict";Object.defineProperty(d,"__esModule",{value:!0});d.fallback=d.circuitBreaker=d.retry=d.wrap=d.timeout=d.usePolicy=d.bulkhead=d.handleWhenResult=d.handleResultType=d.handleWhen=d.handleType=d.handleAll=d.noop=d.Policy=void 0;var Ds=je(),Us=rt(),Is=de(),ht=H(),Cs=nt(),Fs=at(),Os=ut(),Ps=pt(),we=(r,e)=>e?t=>t instanceof r&&e(t):t=>t instanceof r,ks=()=>!0,Q=()=>!1,C=class r{constructor(e){this.options=e}orType(e,t){let s=we(e,t);return new r({...this.options,errorFilter:i=>this.options.errorFilter(i)||s(i)})}orWhen(e){return new r({...this.options,errorFilter:t=>this.options.errorFilter(t)||e(t)})}orWhenResult(e){return new r({...this.options,resultFilter:t=>this.options.resultFilter(t)||e(t)})}orResultType(e,t){let s=we(e,t);return new r({...this.options,resultFilter:i=>this.options.resultFilter(i)||s(i)})}};d.Policy=C;d.noop=new Fs.NoopPolicy;d.handleAll=new C({errorFilter:ks,resultFilter:Q});function Ts(r,e){return new C({errorFilter:we(r,e),resultFilter:Q})}d.handleType=Ts;function qs(r){return new C({errorFilter:r,resultFilter:Q})}d.handleWhen=qs;function Ms(r,e){return new C({errorFilter:Q,resultFilter:we(r,e)})}d.handleResultType=Ms;function Bs(r){return new C({errorFilter:Q,resultFilter:r})}d.handleWhenResult=Bs;function Hs(r,e=0){return new Us.BulkheadPolicy(r,e)}d.bulkhead=Hs;function zs(r){return(e,t,s)=>{let i=s.value;if(typeof i!="function")throw new Error(`Can only decorate functions with @cockatiel, got ${typeof i}`);s.value=function(...o){let n=o[o.length-1]instanceof AbortSignal?o.pop():void 0;return r.execute(a=>i.apply(this,[...o,a]),n)}}}d.usePolicy=zs;function js(r,e){return new Ps.TimeoutPolicy(r,typeof e=="string"?{strategy:e}:e)}d.timeout=js;function Ls(...r){return{_altReturn:void 0,onFailure:r[0].onFailure,onSuccess:r[0].onSuccess,wrapped:r,execute(e,t){let s=(i,o)=>o===r.length?e(i):r[o].execute(n=>s({...i,...n},o+1),i.signal);return Promise.resolve(s({signal:t},0))}}}d.wrap=Ls;function Ws(r,e){return new Os.RetryPolicy({backoff:e.backoff||new Ds.ConstantBackoff(0),maxAttempts:e.maxAttempts??1/0},new ht.ExecuteWrapper(r.options.errorFilter,r.options.resultFilter))}d.retry=Ws;function Gs(r,e){return new Is.CircuitBreakerPolicy(e,new ht.ExecuteWrapper(r.options.errorFilter,r.options.resultFilter))}d.circuitBreaker=Gs;function Ns(r,e){return new Cs.FallbackPolicy(new ht.ExecuteWrapper(r.options.errorFilter,r.options.resultFilter),typeof e=="function"?e:()=>e)}d.fallback=Ns});var mt=f(w=>{"use strict";var Qs=w&&w.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,i)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),R=w&&w.__exportStar||function(r,e){for(var t in r)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&Qs(e,r,t)};Object.defineProperty(w,"__esModule",{value:!0});w.EventEmitter=w.Event=void 0;R(je(),w);R(Jt(),w);R(rt(),w);R(de(),w);var er=U();Object.defineProperty(w,"Event",{enumerable:!0,get:function(){return er.Event}});Object.defineProperty(w,"EventEmitter",{enumerable:!0,get:function(){return er.EventEmitter}});R(ue(),w);R(nt(),w);R(at(),w);R(Kt(),w);R(ut(),w);R(pt(),w)});var tr,rr=v(()=>{"use strict";tr=r=>(e,t)=>{let s,i=0,o=t.length-1;for(;i<=o;)s=Math.floor((i+o)/2),r(t[s])>=e?o=s-1:i=s+1;return i}});var ge,yt,sr=v(()=>{"use strict";ge=Symbol("unset"),yt=r=>{let e=ge,t=()=>(e===ge&&(e=r()),e);return t.getValue=()=>e===ge?void 0:e,t.forget=()=>{e=ge},t}});async function*Js(r,e,t=0,s=1024){let i=new Uint8Array(s);for(let o=0;o<e.length;o++){let n=e[o];if(n.op===1)continue;if(n.op===2){let l=n.offset+n.value.length-t;if(l<=0)continue;let p=l<n.value.length?n.value.subarray(-l):n.value;p.length>0&&(yield p);continue}let a=n.roffset+(o+1<e.length?e[o+1].offset:1/0)-n.offset,c=n.roffset+Math.max(0,t-n.offset);for(;c<a;){let l=await r.read(c,i.subarray(0,Math.min(i.length,a-c)));if(l===0)break;yield i.subarray(0,l),c+=l}}}var ir,$s,D,Vs,z=v(()=>{"use strict";ir=P(mt());rr();sr();$s=r=>r.op===0?{...r,op:1,previous:r.value}:r.op===1?{...r,op:0,value:r.previous}:{...r,value:r.previous,previous:r.value},D=class{constructor(e){this.saveGuard=(0,ir.bulkhead)(1,1/0);this._unsavedEditIndex=0;this.getSizeInner=yt(()=>this.accessor.getSize());this.getEditTimeline=yt(()=>Vs(this._edits));this._edits=e.edits?e.edits.saved.concat(e.edits.unsaved):[],this._unsavedEditIndex=e.edits?.saved.length??0,this.supportsLengthChanges=e.supportsLengthChanges,this.isFiniteSize=e.isFiniteSize,this.accessor=e.accessor,this.pageSize=e.accessor.pageSize}get uri(){return this.accessor.uri}get isReadonly(){return!!this.accessor.isReadonly}async size(){if(!this.isFiniteSize)return;let e=await this.getSizeInner();if(e===void 0)return;let{sizeDelta:t}=this.getEditTimeline();return e+t}get edits(){return this._edits}get unsavedEdits(){return this._edits.slice(this.unsavedEditIndex)}get unsavedEditIndex(){return this._unsavedEditIndex}get isSynced(){return this.unsavedEditIndex===this.edits.length}readInto(e,t){return this.accessor.read(e,t)}readWithEdits(e=0,t=128*1024){return Js(this.accessor,this.getEditTimeline().ranges,e,t)}save(){let e=this._edits.slice(this.unsavedEditIndex);return e.length===0?Promise.resolve():(this._unsavedEditIndex+=e.length,this.saveGuard.execute(async()=>{e.some(t=>t.op!==2||t.previous.length!==t.value.length)?await this.accessor.writeStream(this.readWithEdits()):await this.accessor.writeBulk(e.map(t=>({offset:t.offset,data:t.value}))),this.getSizeInner.forget()}))}revert(){this._unsavedEditIndex=0,this._edits=[],this.accessor.invalidate?.(),this.getEditTimeline.forget(),this.getSizeInner.forget()}makeEdits(e){let t=this._edits.length;return this._edits.push(...e),this.getEditTimeline.forget(),{undo:()=>(this.unsavedEditIndex<=t?this._edits.splice(t,e.length):this._edits.push(...e.map($s)),this.getEditTimeline.forget(),this._edits),redo:()=>(this._edits.push(...e),this.getEditTimeline.forget(),this._edits)}}dispose(){this.accessor.dispose()}};Vs=r=>{let e=[{op:0,editIndex:-1,roffset:0,offset:0}],t=(n,a,c)=>a.op===0?{before:{op:0,editIndex:n,roffset:a.roffset,offset:a.offset},after:{op:0,editIndex:n,roffset:a.roffset+c,offset:a.offset+c}}:a.op===1?{before:{op:1,editIndex:n,offset:a.offset},after:{op:1,editIndex:n,offset:a.offset+c}}:{before:{op:2,editIndex:n,offset:a.offset,value:a.value.subarray(0,c)},after:{op:2,editIndex:n,offset:a.offset+c,value:a.value.subarray(c)}},s=tr(n=>n.offset),i=0,o=(n,a)=>{for(i+=a;n<e.length;n++)e[n].offset+=a};for(let n=0;n<r.length;n++){let a=r[n],c=s(a.offset,e);(c===e.length||e[c].offset>a.offset)&&c--;let l=e[c];if(a.op===0){let{before:p,after:h}=t(n,l,a.offset-l.offset);e.splice(c,1,p,{op:2,editIndex:n,offset:a.offset,value:a.value},h),o(c+2,a.value.length)}else if(a.op===1||a.op===2){let{before:p}=t(n,l,a.offset-l.offset),h=s(a.offset+a.previous.length,e);(h===e.length||e[h].offset>a.offset)&&h--;let{after:b}=t(n,e[h],a.offset+a.previous.length-e[h].offset);e.splice(c,h-c+1,p,a.op===2?{op:2,editIndex:n,offset:a.offset,value:a.value}:{op:1,editIndex:n,offset:a.offset},b),o(c+2,(a.op===2?a.value.length:0)-a.previous.length)}}return{ranges:e,sizeDelta:i}}});var Ys,Zs,Se,en,tn,Xs,$,xe,Ks,Ee,nr,ei,ar,ti,ri,or,cr,si,ii,ni,ur,oi,lr=v(()=>{"use strict";Ys=typeof atob=="function",Zs=typeof btoa=="function",Se=typeof Buffer=="function",en=typeof TextDecoder=="function"?new TextDecoder:void 0,tn=typeof TextEncoder=="function"?new TextEncoder:void 0,Xs="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",$=Array.prototype.slice.call(Xs),xe=(r=>{let e={};return r.forEach((t,s)=>e[t]=s),e})($),Ks=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,Ee=String.fromCharCode.bind(String),nr=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):(r,e=t=>t)=>new Uint8Array(Array.prototype.slice.call(r,0).map(e)),ei=r=>r.replace(/=/g,"").replace(/[+\/]/g,e=>e=="+"?"-":"_"),ar=r=>r.replace(/[^A-Za-z0-9\+\/]/g,""),ti=r=>{let e,t,s,i,o="",n=r.length%3;for(let a=0;a<r.length;){if((t=r.charCodeAt(a++))>255||(s=r.charCodeAt(a++))>255||(i=r.charCodeAt(a++))>255)throw new TypeError("invalid character found");e=t<<16|s<<8|i,o+=$[e>>18&63]+$[e>>12&63]+$[e>>6&63]+$[e&63]}return n?o.slice(0,n-3)+"===".substring(n):o},ri=Zs?r=>btoa(r):Se?r=>Buffer.from(r,"binary").toString("base64"):ti,or=Se?r=>Buffer.from(r).toString("base64"):r=>{let t=[];for(let s=0,i=r.length;s<i;s+=4096)t.push(Ee.apply(null,r.subarray(s,s+4096)));return ri(t.join(""))},cr=(r,e=!1)=>e?ei(or(r)):or(r),si=r=>{if(r=r.replace(/\s+/g,""),!Ks.test(r))throw new TypeError("malformed base64.");r+="==".slice(2-(r.length&3));let e,t="",s,i;for(let o=0;o<r.length;)e=xe[r.charAt(o++)]<<18|xe[r.charAt(o++)]<<12|(s=xe[r.charAt(o++)])<<6|(i=xe[r.charAt(o++)]),t+=s===64?Ee(e>>16&255):i===64?Ee(e>>16&255,e>>8&255):Ee(e>>16&255,e>>8&255,e&255);return t},ii=Ys?r=>atob(ar(r)):Se?r=>Buffer.from(r,"base64").toString("binary"):si,ni=Se?r=>nr(Buffer.from(r,"base64")):r=>nr(ii(r),e=>e.charCodeAt(0)),ur=r=>ni(oi(r)),oi=r=>ar(r.replace(/[-_]/g,e=>e=="-"?"+":"/"))});var bt,ci,ui,M,vt=v(()=>{"use strict";lr();bt=P(require("vscode")),ci=new TextEncoder,ui=new TextDecoder,M=class{constructor(e){this.uri=e}async write(e){let t=JSON.stringify(e,(s,i)=>i instanceof Uint8Array?{$u8:cr(i)}:i);await bt.workspace.fs.writeFile(this.uri,ci.encode(t))}async read(){let e;try{e=ui.decode(await bt.workspace.fs.readFile(this.uri))}catch{return[]}return JSON.parse(e,(t,s)=>s&&typeof s=="object"&&"$u8"in s?ur(s.$u8):s)}}});var j,m,J,wt,li,dr,gt,Re,xt,Et,St,Rt=v(()=>{"use strict";j=P(mt()),m=P(require("vscode")),J=async(r,e)=>{if(r.scheme==="untitled")return new xt(r,e??new Uint8Array);if(r.scheme==="vscode-debug-memory"){let{permissions:t=0}=await m.workspace.fs.stat(r);return new Et(r,!!(t&m.FilePermission.Readonly))}if(r.scheme==="file")try{let t=require("fs"),s=require("os"),i=await t.promises.stat(r.fsPath),{uid:o,gid:n}=s.userInfo(),a=o===-1||o===i.uid?!(i.mode&128):n===i.gid?!(i.mode&16):!(i.mode&2);if(i.isFile())return new gt(r,a,t)}catch{}return new Re(r)},wt=class{constructor(e,t,s){this.path=e;this.flags=t;this._fs=s;this.borrowQueue=[];this.disposed=!1}borrow(e){return this.disposed?Promise.reject(new Error("FileHandle was disposed")):new Promise((t,s)=>{this.borrowQueue.push(async i=>{if(i instanceof Error)return s(i);try{t(await e(i))}catch(o){s(o)}}),this.borrowQueue.length===1&&this.process()})}dispose(){this.disposed=!0,this.handle=void 0,this.disposeTimeout&&clearTimeout(this.disposeTimeout),this.rejectAll(new Error("FileHandle was disposed"))}async close(){await this.handle?.close(),this.handle=void 0,this.disposeTimeout&&clearTimeout(this.disposeTimeout)}rejectAll(e){for(;this.borrowQueue.length;)this.borrowQueue.pop()(e)}async process(){for(this.disposeTimeout&&clearTimeout(this.disposeTimeout);this.borrowQueue.length;){if(!this.handle)try{this.handle=await this._fs.promises.open(this.path,this.flags|this._fs.constants.O_CREAT)}catch(e){return this.rejectAll(e)}await this.borrowQueue[0]?.(this.handle),this.borrowQueue.shift()}this.handle&&(this.disposeTimeout=setTimeout(()=>{this.handle?.close(),this.handle=void 0},1e3))}},li=(0,j.retry)((0,j.handleWhen)(r=>r.code==="ENOENT"),{maxAttempts:50,backoff:new j.ConstantBackoff(50)}),dr=128*1024,gt=class{constructor(e,t,s){this.fs=s;this.supportsIncremetalAccess=!0;this.pageSize=dr;this.uri=e.toString(),this.isReadonly=t,this.handle=new wt(e.fsPath,t?s.constants.O_RDONLY:s.constants.O_RDWR,s)}watch(e,t){return St(this.uri,e,t)}async getSize(){return this.handle.borrow(async e=>(await e.stat()).size)}async read(e,t){return this.handle.borrow(async s=>{let{bytesRead:i}=await s.read(t,0,t.byteLength,e);return i})}writeBulk(e){return this.handle.borrow(async t=>{for(let{data:s,offset:i}of e)t.write(s,0,s.byteLength,i)})}async writeStream(e,t){let s=`${this.handle.path}.tmp`,i=await this.fs.promises.open(s,this.fs.constants.O_WRONLY|this.fs.constants.O_CREAT|this.fs.constants.O_TRUNC);try{let o=0;for await(let n of e){if(t?.isCancellationRequested)return;await i.write(n,0,n.byteLength,o),o+=n.byteLength}}finally{await i.close()}return await this.handle.borrow(async()=>{await this.handle.close(),await li.execute(()=>this.fs.promises.rename(s,this.handle.path))}),this.handle.borrow(async o=>{if(t?.isCancellationRequested)return;let n=0;for await(let a of e){if(t?.isCancellationRequested)return;await o.write(a,0,a.byteLength,n),n+=a.byteLength}})}dispose(){this.handle.dispose()}},Re=class{constructor(e){this.pageSize=dr;this.uri=e.toString(),this.fsPath=e.fsPath,this.isReadonly=m.workspace.fs.isWritableFileSystem(this.uri)===!1}watch(e,t){return St(this.uri,e,t)}async getSize(){return(await m.workspace.fs.stat(m.Uri.parse(this.uri))).size}async read(e,t){let s=await this.getContents(),i=Math.min(t.length,s.length-e);return t.set(s.subarray(e,i+e)),i}async writeStream(e,t){let s=0,i=[];for await(let a of e){if(t?.isCancellationRequested)throw new m.CancellationError;i.push(a),s+=a.length}let o=new Uint8Array(s),n=0;for(let a of i)o.set(a,n),n+=a.length;await m.workspace.fs.writeFile(m.Uri.parse(this.uri),o)}async writeBulk(e){let t=await this.getContents();for(let{data:s,offset:i}of e)t.set(s,i);return m.workspace.fs.writeFile(m.Uri.parse(this.uri),t)}invalidate(){this.contents=void 0}dispose(){this.contents=void 0}getContents(){return this.contents??=m.workspace.fs.readFile(m.Uri.parse(this.uri)),this.contents}},xt=class extends Re{constructor(e,t){super(e),this.contents=t}getSize(){return Promise.resolve(this.contents.byteLength)}},Et=class{constructor(e,t){this.isReadonly=t;this.supportsIncremetalAccess=!0;this.pageSize=4*1024;this.uri=e.toString()}watch(e,t){return St(this.uri,e,t)}async getSize(){}async read(e,t){let s=await m.workspace.fs.readFile(this.referenceRange(e,e+t.length)),i=Math.min(t.length,s.length);return t.set(s.subarray(0,i)),i}async writeStream(){throw new Error("Not supported")}async writeBulk(e){await Promise.all(e.map(t=>m.workspace.fs.writeFile(this.referenceRange(t.offset,t.offset+t.data.length),t.data)))}referenceRange(e,t){return m.Uri.parse(this.uri).with({query:`?range=${e}:${t}`})}invalidate(){}dispose(){}},St=(r,e,t)=>{let s=r.split("/"),i=s.pop(),o=new m.RelativePattern(m.Uri.parse(s.join("/")),i),n=m.workspace.createFileSystemWatcher(o),a=n.onDidChange(e),c=n.onDidDelete(t);return new m.Disposable(()=>{a.dispose(),c.dispose(),n.dispose()})}});var Ae,_t,fr,pr,hr,At,Dt,_e,mr,De=v(()=>{"use strict";Ae=require("crypto"),_t=require("fs"),fr=require("os"),pr=require("path"),hr=P(require("vscode"));Rt();At=[],Dt=async r=>{let e=(0,pr.join)((0,fr.tmpdir)(),`vscode-hexeditor-test-${(0,Ae.randomBytes)(8).toString("hex")}.bin`);return At.push(e),r&&await _t.promises.writeFile(e,r),hr.Uri.file(e)},_e=async r=>J(await Dt(r));afterEach(async()=>{await Promise.all(At.map(_t.promises.unlink)),At=[]});mr=r=>()=>{let e=(0,Ae.createHash)("sha256").update(r).digest();return r=e,e.readUInt32BE()/4294967295}});var di={};var yr,br=v(()=>{"use strict";yr=require("chai");z();vt();De();describe("Backup",()=>{let r=[{op:1,offset:3,previous:new Uint8Array([3,4,5])},{op:2,offset:1,value:new Uint8Array([10,11,12]),previous:new Uint8Array([1,2,6])}];it("round trips",async()=>{let e=new M(await Dt());await e.write(r),(0,yr.expect)(await e.read()).to.deep.equal(r)})})});function fi(r,e){if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0}function pi(r,e=0){e=wr(149417,e);for(let t=0,s=r.length;t<s;t++)e=wr(r[t],e);return e}function wr(r,e){return(e<<5)-e+r|0}var vr,L,It=v(()=>{"use strict";vr=r=>typeof r=="function"?r():r,L=class{constructor(){this.table=new Map}set(e,t){let s=pi(e),i=this.table.get(s);if(!i){let n={buf:e,value:vr(t)};return this.table.set(s,[n]),n.value}for(let n of i)if(fi(n.buf,e))return n.value;let o={buf:e,value:vr(t)};return i.push(o),o.value}*entries(){for(let e of this.table.values())for(let{buf:t,value:s}of e)yield[t,s]}*keys(){for(let e of this.table.values())for(let{buf:t}of e)yield t}*values(){for(let e of this.table.values())for(let{value:t}of e)yield t}}});var gr,xr,Er=v(()=>{"use strict";z();It();gr=r=>{let e=0,t=new L,s=n=>({offset:t.set(n,()=>{let c=e;return e+=n.length,c}),len:n.length}),i=[];for(let n of r)n.op===0?i.push({...n,value:s(n.value)}):n.op===1?i.push({...n,previous:s(n.previous)}):i.push({...n,previous:s(n.previous),value:s(n.value)});let o=new Uint8Array(e);for(let[n,a]of t.entries())o.set(n,a);return{data:o,edits:i}},xr=({edits:r,data:e})=>{let t=({offset:s,len:i})=>e.slice(s,s+i);return r.map(s=>s.op===0?{...s,value:t(s.value)}:s.op===1?{...s,previous:t(s.previous)}:{...s,previous:t(s.previous),value:t(s.value)})}});var hi={};var W,Sr=v(()=>{"use strict";W=require("chai");z();Er();De();describe("HexDocumentModel",()=>{let r=[0,1,2,3,4,5,6,7,8,9],e;beforeEach(async()=>{e=new D({accessor:await _e(new Uint8Array(r)),supportsLengthChanges:!1,isFiniteSize:!0})}),describe("edit timeline",()=>{it("keeps offsets in replacements",()=>{e.makeEdits([{op:2,offset:6,value:new Uint8Array([16]),previous:new Uint8Array([6,7,8])},{op:2,offset:1,value:new Uint8Array([11]),previous:new Uint8Array([1,2,3])}]);let t=e.getEditTimeline();(0,W.expect)(t).to.deep.equal({sizeDelta:-4,ranges:[{op:0,editIndex:1,roffset:0,offset:0},{op:2,editIndex:1,offset:1,value:new Uint8Array([11])},{op:0,editIndex:1,roffset:4,offset:2},{op:2,editIndex:0,offset:4,value:new Uint8Array([16])},{op:0,editIndex:0,roffset:9,offset:5}]})})}),describe("serialization",()=>{it("round trips",()=>{let t=[{op:0,offset:2,value:new Uint8Array([10,11,12])},{op:2,offset:2,value:new Uint8Array([10,11,12]),previous:new Uint8Array([1,2,3])},{op:1,offset:3,previous:new Uint8Array([3,4,5])}],s=gr(t);(0,W.expect)(xr(s)).to.deep.equal(t),(0,W.expect)(s.data.length).to.equal(9)})}),describe("edit reading",()=>{let t=async s=>{for(let i=0;i<s.length;i++){let o=new Uint8Array;for await(let n of e.readWithEdits(i))o=Buffer.concat([o,n]);(0,W.expect)(o).to.deep.equal(Buffer.from(s.subarray(i)),`expected to be equal at offset ${i}`)}(0,W.expect)(await e.size()).to.equal(s.length)};it("reads file verbatim",async()=>{await t(new Uint8Array(r))}),it("reads with a simple insert",async()=>{e.makeEdits([{op:0,offset:2,value:new Uint8Array([10,11,12])}]),await t(new Uint8Array([0,1,10,11,12,2,3,4,5,6,7,8,9]))}),it("reads with a simple delete",async()=>{e.makeEdits([{op:1,offset:2,previous:new Uint8Array([2,3,4])}]),await t(new Uint8Array([0,1,5,6,7,8,9]))}),it("reads with a simple replace",async()=>{e.makeEdits([{op:2,offset:2,value:new Uint8Array([10,11,12]),previous:new Uint8Array([1,2,3])}]),await t(new Uint8Array([0,1,10,11,12,5,6,7,8,9]))}),it("replaces at beginning",async()=>{e.makeEdits([{op:2,offset:0,value:new Uint8Array([10,11,12]),previous:new Uint8Array([0,1,2])}]),await t(new Uint8Array([10,11,12,3,4,5,6,7,8,9]))}),it("makes random replacements",async function(){this.timeout(1e4);let s=new Uint8Array(r),i=mr("vs code!"),o=`- [${s.join(", ")}]
`,n=0;for(let a=0;a<1e3;a++){let c=Math.floor(i()*s.length),l=Math.floor((s.length-c)*i()),p=new Uint8Array(l),h=new Uint8Array(l);for(let b=0;b<l;b++)h[b]=s[c+b],p[b]=s[c+b]=n++&255;o+=`- arr.set(${c}, [${p.join(", ")}]) -> [${s.join(", ")}]
`,e.makeEdits([{op:2,offset:c,value:p,previous:h}]);try{await t(s)}catch(b){throw console.log(o),b}}}),it("works with multiple replacements",async()=>{e.makeEdits([{op:2,offset:6,value:new Uint8Array([16]),previous:new Uint8Array([6,7,8])},{op:2,offset:1,value:new Uint8Array([11]),previous:new Uint8Array([1,2,3])}]),await t(new Uint8Array([0,11,4,5,16,9]))}),it("overlaps replace on delete",async()=>{e.makeEdits([{op:1,offset:3,previous:new Uint8Array([3,4,5])},{op:2,offset:1,value:new Uint8Array([10,11,12]),previous:new Uint8Array([1,2,6])}]),await t(new Uint8Array([0,10,11,12,7,8,9]))}),it("overlaps replace on insert",async()=>{e.makeEdits([{op:0,offset:2,value:new Uint8Array([10,11,12])},{op:2,offset:1,value:new Uint8Array([20,21,22]),previous:new Uint8Array([1,10,11])}]),await t(new Uint8Array([0,20,21,22,12,2,3,4,5,6,7,8,9]))}),it("delete overlaps multiple",async()=>{e.makeEdits([{op:0,offset:2,value:new Uint8Array([10,11,12])},{op:1,offset:1,previous:new Uint8Array([1,10,11,12,2,3])}]),await t(new Uint8Array([0,4,5,6,7,8,9]))})})})});var Ue,Rr,Ct,Ie,Ar=v(()=>{"use strict";Ue=Symbol("Wildcard"),Rr=new Uint8Array(255);for(let r=0;r<255;r++)Rr[r]=r;Ct=new Uint8Array(255);for(let r=0;r<255;r++)Ct[r]=String.fromCharCode(r).toUpperCase().charCodeAt(0);Ie=class{constructor(e,t,s=Rr){this.needle=e;this.onMatch=t;this.equivalencyTable=s;this.needleLen=0;this.index=0;this.usableBuffer=0;for(let i of e)i===Ue?this.needleLen++:this.needleLen+=i.length;this.buffer=new Uint8Array(this.needleLen)}push(e){let{needleLen:t,buffer:s}=this;for(let i=0;i<e.length;i++)s[this.index++%t]=e[i],this.usableBuffer++,this.attemptMatch()}attemptMatch(){let{needle:e,needleLen:t,buffer:s,index:i,equivalencyTable:o}=this;if(this.usableBuffer<t)return;let n=0;for(let c=0;c<e.length;c++){let l=e[c];if(l===Ue){n++;continue}for(let p=0;p<l.length;p++){if(o[l[p]]!==o[s[(i+n)%t]])return;n++}}this.matchTmpBuf||(this.matchTmpBuf=new Uint8Array(t));let a=this.index%t;this.matchTmpBuf.set(s.subarray(a),0),this.matchTmpBuf.set(s.subarray(0,a),t-a),this.onMatch(this.index-t,this.matchTmpBuf),this.usableBuffer=0}}});var Ce,V,mi,Y,_r=v(()=>{"use strict";It();Ar();Ce=class r{constructor(e,t){this.filesize=e;this.cap=t;this.buffers=new L;this.fileOffset=0;this.lastYieldedTime=Date.now();this.results=[]}static{this.targetUpdateInterval=1e3}get capped(){return this.cap===0}push(e,t,s){let i=this.buffers.set(e,()=>new Uint8Array(e));this.cap===void 0?this.results.push({from:t,to:s,previous:i}):this.cap>0&&(this.results.push({from:t,to:s,previous:i}),this.cap--)}toYield(){let e=Date.now();if(e-this.lastYieldedTime>r.targetUpdateInterval){this.lastYieldedTime=e;let t=this.results;return this.results=[],{progress:this.filesize?this.fileOffset/this.filesize:0,results:t}}}final(){return{progress:1,capped:this.capped,results:this.results}}},V=class{constructor(e,t,s,i){this.document=e;this.query=t;this.isCaseSensitive=s;this.cap=i;this.cancelled=!1}dispose(){this.cancelled=!0}async*search(){let{isCaseSensitive:e,query:t,document:s,cap:i}=this,o=new Ce(await s.size(),i),n=new Ie(t.literal.map(a=>a==="*"?Ue:a),(a,c)=>o.push(c,a,a+c.length),e?void 0:Ct);for await(let a of s.readWithEdits(0)){if(this.cancelled||o.capped){yield o.final();return}n.push(a),o.fileOffset+=a.length;let c=o.toYield();c&&(yield c)}yield o.final()}},mi=8*1024,Y=class{constructor(e,t,s,i){this.document=e;this.cap=i;this.cancelled=!1;this.re=new RegExp(t.re,s?"g":"ig")}dispose(){this.cancelled=!0}async*search(){let e="",t=0,{re:s,document:i}=this,o=new TextDecoder("ascii"),n=new TextEncoder,a=new Ce(await i.size(),this.cap);for await(let c of i.readWithEdits(0)){if(this.cancelled||a.capped){yield a.final();return}e+=o.decode(c);let l=0;for(let b of e.matchAll(s)){let Ft=t+e.slice(0,b.index).length,Tr=b[0].length;a.push(n.encode(b[0]),Ft,Ft+Tr),l=b.index+b[0].length}a.fileOffset+=c.length;let p=Math.max(e.length-mi,l);p>0&&(t+=p,s.lastIndex=0,e=e.slice(p));let h=a.toYield();h&&(yield h)}yield a.final()}}});function yi(r){for(;r.length;){let e=r.pop();e&&e.dispose()}}var Fe,Dr=v(()=>{"use strict";Fe=class{constructor(){this._isDisposed=!1;this._disposables=[]}dispose(){this._isDisposed||(this._isDisposed=!0,yi(this._disposables))}_register(e){return this._isDisposed?e.dispose():this._disposables.push(e),e}get isDisposed(){return this._isDisposed}}});var Ur=v(()=>{"use strict"});var Oe,Ir=v(()=>{"use strict";Ur();Oe=class{start(e,t){this._request?.dispose(),this._request=t,(async()=>{for await(let s of t.search())e.sendEvent({type:2,data:s})})()}cancel(){this._request?.dispose(),this._request=void 0}}});var A,Pe,Cr=v(()=>{"use strict";A=P(require("vscode"));z();vt();Dr();Rt();Ir();Pe=class r extends Fe{constructor(t,s,i){super();this.model=t;this.isLargeFile=s;this.baseAddress=i;this.lastSave=0;this._selectionState={selected:0};this.searchProvider=new Oe;this._onDidDispose=this._register(new A.EventEmitter);this.onDidDispose=this._onDidDispose.event;this._onDidChangeSelectionState=this._register(new A.EventEmitter);this.onDidChangeSelectionState=this._onDidChangeSelectionState.event;this._onDidRevert=this._register(new A.EventEmitter);this.onDidRevert=this._onDidRevert.event}static async create(t,{backupId:s,untitledDocumentData:i},o){let n=await J(t,i),a=new D({accessor:n,isFiniteSize:!0,supportsLengthChanges:!0,edits:s?{unsaved:await new M(A.Uri.parse(s)).read(),saved:[]}:void 0}),c=r.parseQuery(t.query),l=c.baseAddress?r.parseHexOrDecInt(c.baseAddress):0,p=await n.getSize();o.sendTelemetryEvent("fileOpen",{},{fileSize:p??0});let h=A.workspace.getConfiguration().get("hexeditor.maxFileSize")*1e6,b=!s&&!n.supportsIncremetalAccess&&(p??0)>h;return{document:new r(a,b,l),accessor:n}}get pageSize(){return this.model.pageSize}get isReadonly(){return this.model.isReadonly}get uri(){return A.Uri.parse(this.model.uri)}readWithEdits(t){return this.model.readWithEdits(t)}async readBufferWithEdits(t,s){let i=new Uint8Array(s),o=0;for await(let n of this.model.readWithEdits(t)){let a=Math.min(n.length,i.length-o);if(i.set(n.subarray(0,a),o),o+=a,o===s)return i}return i.slice(0,o)}async readBuffer(t,s){let i=new Uint8Array(s),o=await this.model.readInto(t,i);return o===s?i:i.slice(0,o)}dispose(){this._onDidDispose.fire(),this.model.dispose(),super.dispose()}get selectionState(){return this._selectionState}set selectionState(t){this._selectionState=t,this._onDidChangeSelectionState.fire(t)}get isSynced(){return this.model.isSynced}get edits(){return this.model.edits}get unsavedEditIndex(){return this.model.unsavedEditIndex}makeEdits(t){return this.model.makeEdits(t)}insert(t,s){return this.model.makeEdits([{op:0,offset:t,value:s}])}async replace(t,s){let i=await this.readBufferWithEdits(t,s.length);return i.length===s.length?this.makeEdits([{op:2,offset:t,value:s,previous:i}]):this.makeEdits([{op:2,offset:t,value:s.subarray(0,i.length),previous:i},{op:0,offset:t+i.length,value:s.subarray(i.length)}])}size(){return this.model.size()}async save(t){this.lastSave=Date.now(),await this.model.save(),this.lastSave=Date.now()}async saveAs(t,s){if(s&&s.isCancellationRequested)return;if(!this.model.isFiniteSize)throw new Error("Cannot save a document without a finite size");let i=await J(t);this.lastSave=Date.now(),await i.writeStream(this.model.readWithEdits()),this.lastSave=Date.now(),this.model.dispose(),this.model=new D({accessor:i,isFiniteSize:!0,supportsLengthChanges:!0})}async revert(t){this.model.revert(),this._onDidRevert.fire()}async backup(t){return await new M(t).write(this.model.unsavedEdits),{id:t.toString(),delete:async()=>{try{await A.workspace.fs.delete(t)}catch{}}}}static parseQuery(t){let s={};if(t){let i=(t[0]==="?"?t.substr(1):t).split("&");for(let o of i){let n=o.split("="),a=n.shift();a&&(s[a]=n.join("="))}}return s}static parseHexOrDecInt(t){return t=t.toLowerCase(),t.startsWith("0x")?parseInt(t.substring(2),16):parseInt(t,10)}}});var bi={};var Fr,Or=v(()=>{"use strict";_r();Fr=require("chai");Cr();De();z();describe("searchRequest",async()=>{let r=`Esse in aliqua minim magna dolor tempor eiusmod exercitation ullamco veniam nisi ipsum cillum commodo. Velit ad aliquip dolor sint anim consequat. Excepteur culpa non adipisicing elit tempor laborum tempor qui. Do esse dolore incididunt consequat non excepteur fugiat fugiat veniam deserunt ut pariatur eiusmod. Deserunt irure qui cupidatat laboris.

Irure nulla nulla consequat reprehenderit nisi nulla consequat dolor. Ad consectetur cillum consectetur ea. Reprehenderit esse in in anim mollit laboris eiusmod. Pariatur enim ipsum dolor eiusmod laboris mollit aliqua ullamco laborum fugiat non et. Officia adipisicing duis id sit aliqua et et occaecat. Commodo Lorem laborum aliquip officia ex quis elit elit do qui consectetur dolore.

Lorem ad ullamco ad deserunt voluptate ullamco et in commodo et exercitation duis nisi. Reprehenderit deserunt deserunt eiusmod velit mollit cillum pariatur Lorem exercitation laboris non. Ad eiusmod mollit reprehenderit amet ex elit deserunt cupidatat ullamco ullamco consectetur elit. Laboris duis cupidatat ipsum id anim occaecat pariatur.`,e=async(n,a)=>{let c;for await(let p of n.search())c=p.results.map(h=>({from:h.from,to:h.to,previous:h.previous}));if(!c)throw new Error("no result");let l=p=>p.sort((h,b)=>h.from-b.from).map(h=>({...h,previous:new TextDecoder().decode(h.previous)}));(0,Fr.expect)(l(c)).to.deep.equal(l(a))},t="laboris",s=new TextEncoder().encode(t),i=[{from:341,previous:s,to:348},{from:496,previous:s,to:503},{from:547,previous:s,to:554},{from:915,previous:s,to:922}],o=async(n=r)=>new Pe(new D({accessor:await _e(new TextEncoder().encode(n)),supportsLengthChanges:!1,isFiniteSize:!0}),!1,0);it("searches for literal",async()=>{let n=await o();await e(new V(n,{literal:[s]},!0,void 0),i)}),it("searches for literal case insensitive",async()=>{let n=await o();await e(new V(n,{literal:[s]},!1,void 0),[...i,{from:1026,previous:new TextEncoder().encode("Laboris"),to:1033}])}),it("searches for regex",async()=>{let n=await o();await e(new Y(n,{re:t},!0,void 0),i)}),it("searches for regex case insensitive",async()=>{let n=await o();await e(new Y(n,{re:t},!1,void 0),[...i,{from:1026,previous:new TextEncoder().encode("Laboris"),to:1033}])})})});function F(r){let e=[],t=new Set(r),s=new Set,i=-1;for(;t.size||s.size;){let o;for(let a of t)(!o||o.start>a.start)&&(o=a);let n;for(let a of s)(!n||n.end>a.end)&&(n=a);o&&(!n||o.start<n.end)?(i!==-1&&s.size&&s.size%2===1&&i!==o.start&&e.push(new u(i,o.start)),i=o.start,s.add(o),t.delete(o)):n&&(s.size%2===1&&i!==n.end&&e.push(new u(i,n.end)),i=n.end,s.delete(n))}return e}var u,Pr=v(()=>{"use strict";u=class r{constructor(e,t=Number.MAX_SAFE_INTEGER,s){this.start=e;this.end=t;if(e<0)throw new Error("Cannot construct a range with a negative start");t<e?([this.start,this.end]=[t,e],s??=1):s??=0,this.direction=s}get size(){return this.end-this.start}static single(e){return new r(e,e+1)}static inclusive(e,t){return t>=e?new r(e,t+1):new r(e+1,t)}includes(e){return e>=this.start&&e<this.end}expandToContain(e){return e<this.start?new r(e,this.end,this.direction):e>=this.end?new r(this.start,e+1,this.direction):this}overlaps(e){return e.end>this.start&&e.start<this.end}difference(e){if(!this.overlaps(e))return[this,e];let t=[];return this.start!==e.start&&t.push(new r(e.start,this.start)),this.end!==e.end&&t.push(new r(e.end,this.end)),t}}});var vi={};var O,kr=v(()=>{"use strict";O=require("chai");Pr();describe("Range",()=>{describe("getRangeSelectionsFromStack",()=>{it("works for a single",()=>{(0,O.expect)(F([new u(10,20)])).to.deep.equal([new u(10,20)])}),it("works for non-overlapping",()=>{(0,O.expect)(F([new u(10,20),new u(30,40)])).to.deep.equal([new u(10,20),new u(30,40)])}),it("excludes overlapping",()=>{(0,O.expect)(F([new u(10,20),new u(30,40),new u(15,35)])).to.deep.equal([new u(10,15),new u(20,30),new u(35,40)])}),it("excludes identity",()=>{(0,O.expect)(F([new u(10,20),new u(10,20)])).to.deep.equal([])}),it("includes identity",()=>{(0,O.expect)(F([new u(10,20),new u(10,20),new u(10,20)])).to.deep.equal([new u(10,20)])}),it("pyramid#1",()=>{(0,O.expect)(F([new u(0,100),new u(10,90),new u(20,80),new u(30,70),new u(40,60)])).to.deep.equal([new u(0,10),new u(20,30),new u(40,60),new u(70,80),new u(90,100)])}),it("pyramid#2",()=>{(0,O.expect)(F([new u(0,50),new u(10,60),new u(20,70),new u(30,80)])).to.deep.equal([new u(0,10),new u(20,30),new u(50,60),new u(70,80)])})})})});var xi={};jr(xi,{run:()=>gi});module.exports=Lr(xi);var Z=P(require("mocha")),wi=[()=>Promise.resolve().then(()=>(br(),di)),()=>Promise.resolve().then(()=>(Sr(),hi)),()=>Promise.resolve().then(()=>(Or(),bi)),()=>Promise.resolve().then(()=>(kr(),vi))];async function gi(){let r=new Z.default({ui:"bdd",color:!0});for(let e of wi)r.suite.emit(Z.default.Suite.constants.EVENT_FILE_PRE_REQUIRE,global,e,r),await e(),r.suite.emit(Z.default.Suite.constants.EVENT_FILE_REQUIRE,{},e,r),r.suite.emit(Z.default.Suite.constants.EVENT_FILE_POST_REQUIRE,global,e,r);return new Promise((e,t)=>{r.run(s=>{s>0?t(new Error(`${s} tests failed.`)):e()})})}0&&(module.exports={run});
